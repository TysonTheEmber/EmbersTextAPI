name: Publish Maven

on:
  push:
    tags: ['v*']
  workflow_dispatch:

# Target repository for the Maven GitHub Pages site.
# Change this env var if you rename or move the repo.
env:
  MAVEN_REPO: TysonTheEmber/maven-repo

jobs:
  publish-maven:
    runs-on: ubuntu-latest
    name: Publish to Maven (GitHub Pages)

    steps:
      - name: Checkout mod source
        uses: actions/checkout@v4

      # Both JDKs are needed so Gradle toolchain can pick the right one per subproject:
      # Java 17 → forge-1.20.1, fabric-1.20.1
      # Java 21 → fabric-1.21.1, neoforge-1.21.1
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            VERSION=$(grep -oP '^mod_version=\K.*' gradle.properties)
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Using version: $VERSION"

      # Checkout (or initialise) the gh-pages branch of the Maven repo so that
      # Gradle's maven-publish can read and merge existing maven-metadata.xml files.
      - name: Checkout Maven repo (gh-pages)
        run: |
          mkdir -p maven-pages
          cd maven-pages
          git init
          git remote add origin \
            https://x-access-token:${{ secrets.MAVEN_REPO_PAT }}@github.com/${{ env.MAVEN_REPO }}.git
          # Fetch the branch if it already exists; silently ignore if not (first run).
          git fetch origin gh-pages --depth=1 2>/dev/null || true
          git checkout gh-pages 2>/dev/null || git checkout -b gh-pages

      # Run all four publish tasks in a single Gradle invocation so the daemon
      # is shared and Gradle's up-to-date checks apply across modules.
      # -PmavenRepoPath points publish output straight into the checked-out Pages dir,
      # so existing maven-metadata.xml entries for older versions are preserved.
      - name: Publish all artifacts to Maven repo
        run: |
          ./gradlew \
            :forge-1.20.1:publishMavenJavaPublicationToLocalMavenRepository \
            :fabric-1.20.1:publishMavenJavaPublicationToLocalMavenRepository \
            :fabric-1.21.1:publishMavenJavaPublicationToLocalMavenRepository \
            :neoforge-1.21.1:publishMavenJavaPublicationToLocalMavenRepository \
            -Pmod_version=${{ steps.version.outputs.version }} \
            -PmavenRepoPath="${{ github.workspace }}/maven-pages" \
            --no-daemon

      # GitHub Pages needs a CNAME file at the repo root to serve the custom domain.
      - name: Write CNAME
        run: echo "maven.tysontheember.dev" > maven-pages/CNAME

      - name: Commit and push Maven artifacts
        run: |
          cd maven-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          # Only commit if something actually changed (idempotent re-runs are safe).
          git diff --staged --quiet \
            && echo "Nothing new to commit." \
            || git commit -m "Publish ${{ steps.version.outputs.version }}"
          git push origin gh-pages
