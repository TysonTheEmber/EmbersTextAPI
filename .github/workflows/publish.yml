name: Publish Mod

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  publish:
    name: Publish ${{ matrix.display_name_suffix }}
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        include:
          # Module paths reflect this repo's layout (e.g., forge-1.20.1 subproject).
          - id: forge-1201
            mc_versions: ["1.20.1"]
            loaders: ["forge"]
            gradle_task: ":forge-1.20.1:build"
            jar_glob: "forge-1.20.1/build/libs/*forge-1.20.1*.jar"
            display_name_suffix: "Forge 1.20.1"
          - id: fabric-1201
            mc_versions: ["1.20.1"]
            loaders: ["fabric"]
            gradle_task: ":fabric-1.20.1:build"
            jar_glob: "fabric-1.20.1/build/libs/*fabric-1.20.1*.jar"
            display_name_suffix: "Fabric 1.20.1"
          - id: neoforge-1211
            mc_versions: ["1.21.1"]
            loaders: ["neoforge"]
            gradle_task: ":neoforge-1.21.1:build"
            jar_glob: "neoforge-1.21.1/build/libs/*neoforge-1.21.1*.jar"
            display_name_suffix: "NeoForge 1.21.1"
          - id: fabric-1211
            mc_versions: ["1.21.1"]
            loaders: ["fabric"]
            gradle_task: ":fabric-1.21.1:build"
            jar_glob: "fabric-1.21.1/build/libs/*fabric-1.21.1*.jar"
            display_name_suffix: "Fabric 1.21.1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            raw="${GITHUB_REF_NAME}"
            cleaned="${raw#v}"
          else
            cleaned="$(date -u +'%Y%m%d%H%M%S')-snapshot"
          fi
          echo "version=$cleaned" >> "$GITHUB_OUTPUT"

      - name: Prepare release notes
        id: notes
        shell: bash
        run: |
          set -e
          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            tag_msg=$(git for-each-ref --format='%(contents)' "refs/tags/${GITHUB_REF_NAME}" || true)
            if [ -n "$tag_msg" ]; then
              {
                echo "notes<<EOF"
                printf "%s\n" "$tag_msg"
                echo "EOF"
              } >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          if [ -f CHANGELOG.md ]; then
            {
              echo "notes<<EOF"
              cat CHANGELOG.md
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            exit 0
          fi

          last_msg=$(git log -1 --pretty=%B)
          {
            echo "notes<<EOF"
            printf "%s\n" "$last_msg"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build ${{ matrix.display_name_suffix }}
        shell: bash
        run: |
          set -e
          task="${{ matrix.gradle_task }}"
          ./gradlew "$task"

      - name: Locate built jar
        id: jar
        shell: bash
        run: |
          set -e
          shopt -s nullglob
          pattern="${{ matrix.jar_glob }}"
          matches=($(ls -1 $pattern 2>/dev/null | grep -v '\-sources\.jar' || true))

          if [ ${#matches[@]} -eq 0 ]; then
            echo "No jars matched pattern: $pattern" >&2
            exit 1
          fi

          if [ ${#matches[@]} -gt 1 ]; then
            jar=$(ls -1t "${matches[@]}" | head -n1)
            echo "Multiple jars found, using newest: $jar"
          else
            jar="${matches[0]}"
          fi

          echo "jar=$jar" >> "$GITHUB_OUTPUT"

      - name: Publish ${{ matrix.display_name_suffix }}
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: ${{ secrets.MODRINTH_PROJECT_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          curseforge-id: ${{ secrets.CURSEFORGE_PROJECT_ID }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
          loaders: ${{ join(matrix.loaders, ',') }}
          game-versions: ${{ join(matrix.mc_versions, ',') }}
          files: ${{ steps.jar.outputs.jar }}
          name: ${{ steps.version.outputs.version }} - ${{ matrix.display_name_suffix }}
          version: ${{ steps.version.outputs.version }}
          version-type: release
          changelog: ${{ steps.notes.outputs.notes }}
